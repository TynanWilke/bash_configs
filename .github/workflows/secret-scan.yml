name: Secret Scanner

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  secret-scan:
    name: Scan for secrets and sensitive data
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better scanning

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Gitleaks Detection
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Check for common secret patterns
        run: |
          echo "Scanning for common secret patterns..."

          # Define patterns to search for
          PATTERNS=(
            "api[_-]?key"
            "api[_-]?secret"
            "aws[_-]?access[_-]?key"
            "aws[_-]?secret[_-]?key"
            "bearer\s+[a-zA-Z0-9\-_\.]+\s*"
            "password\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
            "token\s*=\s*['\"][^'\"]+['\"]"
            "AKIA[0-9A-Z]{16}"  # AWS Access Key
            "github[_-]?token"
            "gh[pousr]_[0-9a-zA-Z]{36}"  # GitHub tokens
            "sk-[a-zA-Z0-9]{48}"  # OpenAI API keys
            "xox[baprs]-[0-9a-zA-Z-]+"  # Slack tokens
            "private[_-]?key"
            "-----BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY"
          )

          # Files to exclude from scanning
          EXCLUDE_FILES=(
            ".github/workflows/secret-scan.yml"
            "README.md"
          )

          # Create exclude pattern for grep
          EXCLUDE_PATTERN=""
          for file in "${EXCLUDE_FILES[@]}"; do
            EXCLUDE_PATTERN="$EXCLUDE_PATTERN --exclude=$file"
          done

          found_secrets=0

          for pattern in "${PATTERNS[@]}"; do
            echo "Checking pattern: $pattern"
            if grep -r -i -n -E "$pattern" . \
              --exclude-dir=.git \
              --exclude-dir=node_modules \
              $EXCLUDE_PATTERN \
              | grep -v "^Binary file"; then
              echo "⚠️  Found potential secret matching pattern: $pattern"
              found_secrets=1
            fi
          done

          if [ $found_secrets -eq 1 ]; then
            echo ""
            echo "❌ Potential secrets or sensitive data detected!"
            echo "Please review the findings above and remove any sensitive information."
            exit 1
          else
            echo ""
            echo "✅ No obvious secrets detected in custom pattern scan."
          fi

      - name: Check for hardcoded IPs and emails
        run: |
          echo "Scanning for hardcoded IPs and emails..."

          found_issues=0

          # Check for private IP addresses (excluding common examples and documentation)
          if grep -r -n -E "([0-9]{1,3}\.){3}[0-9]{1,3}" . \
            --exclude-dir=.git \
            --exclude-dir=node_modules \
            --exclude=secret-scan.yml \
            | grep -v "127.0.0.1" \
            | grep -v "0.0.0.0" \
            | grep -v "255.255.255" \
            | grep -v "example" \
            | grep -v "^Binary file"; then
            echo "⚠️  Found hardcoded IP addresses"
            found_issues=1
          fi

          # Check for email addresses (excluding documentation)
          if grep -r -n -E "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" . \
            --exclude-dir=.git \
            --exclude-dir=node_modules \
            --exclude=secret-scan.yml \
            --exclude=README.md \
            | grep -v "example.com" \
            | grep -v "noreply" \
            | grep -v "^Binary file"; then
            echo "⚠️  Found email addresses"
            found_issues=1
          fi

          if [ $found_issues -eq 1 ]; then
            echo ""
            echo "⚠️  Hardcoded IPs or emails detected. Please review if these should be committed."
            # Don't fail on this check, just warn
          else
            echo "✅ No hardcoded IPs or emails detected."
          fi

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "================================================"
          echo "✅ Secret scanning completed successfully!"
          echo "================================================"
          echo ""
          echo "All checks passed. No secrets detected."
